<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ‚Äî Tornadoes Handball</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        /* Remove custom admin styles and use dashboard theme */
        body, .page-wrapper {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font);
        }
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }
        .card:hover {
            background: var(--bg-card-hover);
            box-shadow: var(--shadow-lg);
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.7rem;
            margin-bottom: 1.2rem;
        }
        .section-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
            color: var(--accent);
        }
        .table-wrapper th, .table-wrapper td {
            padding: 0.7rem;
            border-bottom: 1px solid var(--border);
            text-align: left;
            color: var(--text-primary);
        }
        .table-wrapper th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--accent);
        }
        .btn {
            border-radius: var(--radius-sm);
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            font-weight: 500;
            transition: var(--transition);
        }
        .btn-primary {
            background: var(--accent);
            color: #fff;
            border: none;
        }
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        .btn-outline {
            background: var(--bg-primary);
            color: var(--accent);
            border: 1.5px solid var(--accent);
        }
        .btn-outline:hover {
            background: var(--bg-secondary);
        }
        .btn-danger {
            background: var(--danger);
            color: #fff;
            border: none;
        }
        .btn-danger:hover {
            background: #b71c1c;
        }
        .badge-role {
            background: var(--accent-subtle);
            color: var(--accent);
            border-radius: var(--radius-sm);
            padding: 0.25rem 0.7rem;
            font-size: 0.98rem;
        }
        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 2rem 1.2rem;
            min-width: 320px;
            max-width: 95vw;
            color: var(--text-primary);
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-label {
            font-family: var(--font);
            font-weight: 600;
            color: var(--text-secondary);
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 1rem;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .invalid-feedback {
            color: var(--danger);
            font-size: 0.92rem;
            margin-top: 0.2rem;
        }
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 2000;
        }
        .toast {
            background: var(--bg-secondary);
            color: var(--accent);
            border-radius: var(--radius-sm);
            padding: 0.7rem 1.2rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            box-shadow: var(--shadow-sm);
        }
        .toast-success { background: var(--success); color: #fff; }
        .toast-error { background: var(--danger); color: #fff; }
        select:disabled, option[value=""] {
            color: var(--text-muted);
        }
        hr.section-divider {
            border: none;
            border-top: 2px solid var(--border);
            margin: 2rem 0;
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <nav class="navbar">
            <div class="container">
                <a href="/" class="navbar-brand"><img src="FirstTeamLogo.svg" alt="Tornadoes Logo" class="navbar-logo" style="height: 40px; vertical-align: middle;" /> Tornadoes</a>
                <ul class="navbar-links">
                    <li><a href="/dashboard.html">Dashboard</a></li>
                    <li><a href="/matches.html">Matches</a></li>
                    <li><a href="/attendance.html">Attendance</a></li>
                    <li><a href="/antidoping.html">Anti-Doping</a></li>
                    <li><a href="/admin.html" class="active">Admin</a></li>
                </ul>
                <div class="navbar-auth">
                    <button onclick="logout()" class="btn btn-outline btn-sm">Logout</button>
                </div>
            </div>
        </nav>

        <div class="page-content">
            <div class="container">
                <h2 style="margin-bottom:2rem;">‚öôÔ∏è Admin Panel</h2>

                <!-- Pending Announcements -->
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="section-header" style="margin-bottom:1rem;">
                        <h3>üì¢ Pending Announcements</h3>
                    </div>
                    <div id="pendingAnn">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>

                <!-- User Management -->
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="section-header" style="margin-bottom:1rem;">
                        <h3>üë• Team Members</h3>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="usersBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Season Management -->
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="section-header" style="margin-bottom:1rem;">
                        <h3>üèÜ Seasons</h3>
                        <button class="btn btn-primary btn-sm"
                            onclick="document.getElementById('seasonForm').classList.toggle('hidden')">+ New
                            Season</button>
                    </div>
                    <form id="seasonForm" class="hidden" onsubmit="createSeason(event)" style="margin-bottom:1rem;">
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:flex-end;">
                            <div class="form-group" style="margin-bottom:0; flex:1; min-width:150px;">
                                <label class="form-label" for="sName">Name</label>
                                <input class="form-input" id="sName" required placeholder="e.g. 2026 Season">
                                <div class="invalid-feedback" id="sNameError"></div>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label" for="sStart">Start</label>
                                <input class="form-input" type="date" id="sStart" required>
                                <div class="invalid-feedback" id="sStartError"></div>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label" for="sEnd">End</label>
                                <input class="form-input" type="date" id="sEnd" required>
                                <div class="invalid-feedback" id="sEndError"></div>
                            </div>
                            <button class="btn btn-primary btn-sm" type="submit">Create</button>
                        </div>
                    </form>
                    <div id="seasonsList"></div>
                </div>

                <!-- Tournament Management -->
                <div class="card">
                    <div class="section-header" style="margin-bottom:1rem;">
                        <h3>üèÖ Tournaments</h3>
                        <button class="btn btn-primary btn-sm"
                            onclick="document.getElementById('tournamentForm').classList.toggle('hidden')">+ New
                            Tournament</button>
                    </div>
                    <form id="tournamentForm" class="hidden" onsubmit="createTournament(event)" style="margin-bottom:1rem;">
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:flex-end;">
                            <div class="form-group" style="margin-bottom:0; flex:1; min-width:150px;">
                                <label class="form-label" for="tName">Name</label>
                                <input class="form-input" id="tName" required placeholder="e.g. County League">
                                <div class="invalid-feedback" id="tNameError"></div>
                            </div>
                            <div class="form-group" style="margin-bottom:0; flex:1; min-width:150px;">
                                <label class="form-label" for="tVenue">Venue</label>
                                <input class="form-input" id="tVenue" required placeholder="e.g. City Stadium">
                                <div class="invalid-feedback" id="tVenueError"></div>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label" for="tDate">Date</label>
                                <input class="form-input" type="date" id="tDate" required>
                                <div class="invalid-feedback" id="tDateError"></div>
                            </div>
                            <button class="btn btn-primary btn-sm" type="submit">Create</button>
                        </div>
                    </form>
                    <div id="tournamentsList"></div>
                </div>

                <!-- Match Management -->
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="section-header" style="margin-bottom:1rem;">
                        <h3>üìÖ Matches</h3>
                        <button class="btn btn-primary btn-sm" onclick="showMatchForm()">+ New Match</button>
                    </div>
                    <form id="matchForm" class="hidden" onsubmit="createMatch(event)" style="margin-bottom:1rem;">
                        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:flex-end;">
                            <div class="form-group" style="margin-bottom:0; flex:1; min-width:150px;">
                                <label class="form-label">Opponent Team(s)</label>
                                <input class="form-input" id="mOpponent" required placeholder="e.g. Team A, Team B">
                            </div>
                            <div class="form-group" style="margin-bottom:0; flex:1; min-width:150px;">
                                <label class="form-label">Venue(s)</label>
                                <input class="form-input" id="mVenue" required placeholder="e.g. City Stadium, Arena">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label">Time(s)</label>
                                <input class="form-input" id="mTime" required placeholder="e.g. 15:00, 17:00">
                            </div>
                            <button class="btn btn-primary btn-sm" type="submit">Create</button>
                        </div>
                    </form>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Opponent</th>
                                    <th>Venue</th>
                                    <th>Time</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="adminMatchesBody"></tbody>
                        </table>
                    </div>
                    <p id="noAdminMatches" class="text-muted text-center mt-2 hidden">No matches found.</p>
                </div>

                <!-- Attendance Management -->
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="section-header" style="margin-bottom:1rem;">
                        <h3>üìù Attendance</h3>
                    </div>
                    <div style="margin-bottom:1rem;">
                        <label class="form-label" for="attendanceDate">Date</label>
                        <input class="form-input" type="date" id="attendanceDate" value="" required>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Present?</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceBody"></tbody>
                        </table>
                    </div>
                    <div class="flex gap-1" style="margin-top:1rem;">
                        <button class="btn btn-primary" onclick="saveAttendance()">Save Attendance</button>
                    </div>
                </div>

                <!-- Add/Edit Match Modal -->
                <div class="modal-overlay" id="adminMatchModal">
                    <div class="modal">
                        <h3 id="adminMatchModalTitle">Add Match</h3>
                        <form onsubmit="submitAdminMatch(event)">
                            <input type="hidden" id="adminMatchId">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input class="form-input" type="date" id="adminMDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adminMOpponent">Opponent</label>
                                <input class="form-input" id="adminMOpponent" required>
                                <div class="invalid-feedback" id="adminMOpponentError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adminMVenue">Venue</label>
                                <input class="form-input" id="adminMVenue" required>
                                <div class="invalid-feedback" id="adminMVenueError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adminMSeason">Season</label>
                                <select class="form-select" id="adminMSeason" required></select>
                                <div class="invalid-feedback" id="adminMDateError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adminMTournament">Tournament (optional)</label>
                                <select class="form-select" id="adminMTournament">
                                    <option value="">None</option>
                                </select>
                                <div class="invalid-feedback" id="adminMSeasonError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adminMLink">Match Link (optional)</label>
                                <input class="form-input" id="adminMLink" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adminMResult">Result (optional)</label>
                                <select class="form-select" id="adminMResult">
                                    <option value="">‚Äî</option>
                                    <option value="win">Win</option>
                                    <option value="loss">Loss</option>
                                    <option value="draw">Draw</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="adminMScore">Score (optional)</label>
                                <input class="form-input" id="adminMScore" placeholder="e.g. 28-24">
                            </div>
                            <div class="flex gap-1">
                                <button type="submit" class="btn btn-primary">Save</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal('adminMatchModal')">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit User Modal -->
                <div class="modal-overlay" id="editUserModal">
                    <div class="modal">
                        <h3>Edit User</h3>
                        <form onsubmit="submitEditUser(event)">
                            <input type="hidden" id="editUserId">
                            <div class="form-group">
                                <label class="form-label" for="editUName">Name</label>
                                <input class="form-input" id="editUName" required>
                                <div class="invalid-feedback" id="editUNameError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="editUEmail">Email</label>
                                <input class="form-input" id="editUEmail" required type="email">
                                <div class="invalid-feedback" id="editUEmailError"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="editURole">Role</label>
                                <select class="form-select" id="editURole" required>
                                    <option value="player">Player</option>
                                    <option value="coach">Coach</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <div class="invalid-feedback" id="editURoleError"></div>
                            </div>
                            <div class="flex gap-1">
                                <button type="submit" class="btn btn-primary">Save</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal('editUserModal')">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Season Modal -->
                <div class="modal-overlay" id="editSeasonModal">
                    <div class="modal">
                        <h3>Edit Season</h3>
                        <form onsubmit="submitEditSeason(event)">
                            <input type="hidden" id="editSeasonId">
                            <div class="form-group">
                                <label class="form-label" for="editSName">Name</label>
                                <input class="form-input" id="editSName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="editSStart">Start</label>
                                <input class="form-input" type="date" id="editSStart" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="editSEnd">End</label>
                                <input class="form-input" type="date" id="editSEnd" required>
                            </div>
                            <div class="flex gap-1">
                                <button type="submit" class="btn btn-primary">Save</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal('editSeasonModal')">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Tournament Modal -->
                <div class="modal-overlay" id="editTournamentModal">
                    <div class="modal">
                        <h3>Edit Tournament</h3>
                        <form onsubmit="submitEditTournament(event)">
                            <input type="hidden" id="editTournamentId">
                            <div class="form-group">
                                <label class="form-label" for="editTName">Name</label>
                                <input class="form-input" id="editTName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="editTSeason">Season</label>
                                <select class="form-select" id="editTSeason" required></select>
                            </div>
                            <div class="flex gap-1">
                                <button type="submit" class="btn btn-primary">Save</button>
                                <button type="button" class="btn btn-outline" onclick="closeModal('editTournamentModal')">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="container">¬© 2026 Tornadoes Handball</div>
        </footer>
    </div>
    <div class="toast-container" id="toasts"></div>

    <script>

        // Utility to close modals by id
        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove('active');
        }

                // Stub for missing showEditSeason to prevent JS error
                function showEditSeason(id) {
                    showToast('Edit season functionality not yet implemented.', 'error');
                }

                // Stub for missing saveAttendance to prevent JS error
                async function saveAttendance() {
                    const date = document.getElementById('attendanceDate').value;
                    if (!date) {
                        showToast('Please select a date for attendance.', 'error');
                        return;
                    }
                    // Collect attendance data from checkboxes
                    const rows = Array.from(document.querySelectorAll('#attendanceBody tr'));
                    const records = rows.map(row => {
                        const userCell = row.querySelector('td strong');
                        const userName = userCell ? userCell.textContent : '';
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        const idMatch = checkbox ? checkbox.id.match(/attend_(\d+)/) : null;
                        const user_id = idMatch ? parseInt(idMatch[1], 10) : null;
                        return user_id ? { user_id, present: checkbox.checked, date } : null;
                    }).filter(Boolean);
                    if (!records.length) {
                        showToast('No attendance records to save.', 'error');
                        return;
                    }
                    try {
                        const res = await fetch('/api/attendance/bulk', {
                            method: 'POST',
                            headers: authHeaders(),
                            body: JSON.stringify({ records, date, match_id: null })
                        });
                        const data = await res.json();
                        if (res.ok && data.message) {
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message || 'Failed to save attendance.', 'error');
                        }
                    } catch {
                        showToast('Network error', 'error');
                    }
                }
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        // Parse JWT to extract claims (role, etc.)
        function parseJwt (token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch { return {}; }
        }
        const claims = parseJwt(token);
        const role = claims.role;

        function authHeaders() { return { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }; }
        function showToast(m, t = 'success') { const d = document.createElement('div'); d.className = `toast toast-${t}`; d.textContent = m; document.getElementById('toasts').appendChild(d); setTimeout(() => d.remove(), 3500); }
        function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function logout() { localStorage.clear(); window.location.href = '/'; }

        // ‚îÄ‚îÄ‚îÄ Pending Announcements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadPending() {
            try {
                const res = await fetch('/api/announcements/pending', { headers: authHeaders() });
                const data = await res.json();
                const div = document.getElementById('pendingAnn');
                if (!data.length) { div.innerHTML = '<p class="text-muted">No pending announcements. üéâ</p>'; return; }
                div.innerHTML = data.map(a => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:0.7rem 0; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:0.5rem;">
                <div>
                    <strong>${esc(a.title)}</strong>
                    <span class="text-muted" style="font-size:0.8rem;"> ‚Äî ${esc(a.content).substring(0, 80)}...</span>
                </div>
                <div>
                    <button class="btn btn-success btn-sm" onclick="approveAnn(${a.id})">‚úì Approve</button>
                    <button class="btn btn-danger btn-sm" style="margin-left:0.5rem;" onclick="rejectAnn(${a.id})">‚úó Reject</button>
                </div>
            </div>
        `).join('');
            } catch { }
        }

        async function approveAnn(id) {
            try {
                const res = await fetch('/api/announcements/approve', {
                    method: 'POST', headers: authHeaders(),
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) { showToast('Approved'); loadPending(); }
                else showToast(data.message, 'error');
            } catch { showToast('Network error', 'error'); }
        }

        async function rejectAnn(id) {
            if (!confirm('Are you sure you want to reject this announcement? This cannot be undone.')) return;
            try {
                const res = await fetch('/api/announcements/reject', {
                    method: 'POST', headers: authHeaders(),
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) { showToast('Announcement rejected'); loadPending(); }
                else showToast(data.message, 'error');
            } catch { showToast('Network error', 'error'); }
        }

        // ‚îÄ‚îÄ‚îÄ Users ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadUsers() {
            try {
                const res = await fetch('/api/users', { headers: authHeaders() });
                const users = await res.json();
                // Show all users (players, coaches, admins) with their roles
                document.getElementById('usersBody').innerHTML = users.map(u => {
                    const displayName = (u.first_name && u.last_name) ? `${esc(u.first_name)} ${esc(u.last_name)}` : esc(u.name);
                    return `
            <tr>
                <td><strong>${displayName}</strong></td>
                <td>${esc(u.email)}</td>
                <td><span class="badge badge-role">${u.role}</span></td>
                <td>
                    ${role === 'admin' ? `
                        <button class="btn btn-outline btn-sm" onclick="showEditUser(${u.id})">Edit</button>
                        <select class="form-select" style="width:auto; display:inline-block; margin-left:0.5rem;" onchange="changeRole(${u.id}, this.value)">
                            <option value="player" ${u.role === 'player' ? 'selected' : ''}>Player</option>
                            <option value="coach" ${u.role === 'coach' ? 'selected' : ''}>Coach</option>
                            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <button class="btn btn-danger btn-sm" style="margin-left:0.5rem;" onclick="deleteUser(${u.id})">Delete</button>
                    ` : '‚Äî'}
                </td>
            </tr>
        `;
                }).join('');
                // Also update attendance table with all users
                document.getElementById('attendanceBody').innerHTML = users.map(u => `
            <tr>
                <td><strong>${esc(u.name)}</strong> <span class="text-muted">(${u.role})</span></td>
                <td><input type="checkbox" id="attend_${u.id}" /></td>
            </tr>
        `).join('');
            } catch { }
        }

        async function changeRole(userId, roleName) {
            try {
                const res = await fetch('/api/users/role', {
                    method: 'POST', headers: authHeaders(),
                    body: JSON.stringify({ user_id: userId, role_name: roleName })
                });
                const data = await res.json();
                if (data.success) showToast(data.message);
                else showToast(data.message, 'error');
            } catch { showToast('Network error', 'error'); }
        }

        // ‚îÄ‚îÄ‚îÄ Seasons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadSeasons() {
            try {
                const res = await fetch('/api/seasons');
                const seasons = await res.json();
                document.getElementById('seasonsList').innerHTML = seasons.map(s => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--border);">
                <div>
                    <strong>${esc(s.name)}</strong>
                    <span class="text-muted">${s.start_date} ‚Üí ${s.end_date}</span>
                </div>
                <div>
                    <button class="btn btn-outline btn-sm" onclick="showEditSeason(${s.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSeason(${s.id})">Delete</button>
                </div>
            </div>
        `).join('') || '<p class="text-muted">No seasons yet.</p>';

                // Populate tournament season dropdown
                document.getElementById('tSeason').innerHTML = seasons.map(s => `<option value="${s.id}">${esc(s.name)}</option>`).join('');
            } catch { }
        }

        async function createSeason(e) {
            e.preventDefault();
            let valid = true;
            if (!document.getElementById('sName').value) {
                document.getElementById('sNameError').textContent = 'Name required'; valid = false;
            } else { document.getElementById('sNameError').textContent = ''; }
            if (!document.getElementById('sStart').value) {
                document.getElementById('sStartError').textContent = 'Start date required'; valid = false;
            } else { document.getElementById('sStartError').textContent = ''; }
            if (!document.getElementById('sEnd').value) {
                document.getElementById('sEndError').textContent = 'End date required'; valid = false;
            } else { document.getElementById('sEndError').textContent = ''; }
            if (!valid) return;
            try {
                const res = await fetch('/api/seasons', {
                    method: 'POST', headers: authHeaders(),
                    body: JSON.stringify({
                        name: document.getElementById('sName').value,
                        start_date: document.getElementById('sStart').value,
                        end_date: document.getElementById('sEnd').value
                    })
                });
                const data = await res.json();
                if (data.success) { showToast('Season created'); loadSeasons(); document.getElementById('seasonForm').classList.add('hidden'); }
                else showToast(data.message, 'error');
            } catch { showToast('Network error', 'error'); }
        }

        // ‚îÄ‚îÄ‚îÄ Tournaments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadTournaments() {
            try {
                const res = await fetch('/api/tournaments');
                const data = await res.json();
                document.getElementById('tournamentsList').innerHTML = data.map(t => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--border);">
                <strong>${esc(t.name)}</strong>
                <div>
                    <button class="btn btn-outline btn-sm" onclick="showEditTournament(${t.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTournament(${t.id})">Delete</button>
                </div>
            </div>
        `).join('') || '<p class="text-muted">No tournaments yet.</p>';
            } catch { }
        }

        async function createTournament(e) {
            e.preventDefault();
            let valid = true;
            if (!document.getElementById('tName').value) {
                document.getElementById('tNameError').textContent = 'Name required'; valid = false;
            } else { document.getElementById('tNameError').textContent = ''; }
            if (!document.getElementById('tVenue').value) {
                document.getElementById('tVenueError').textContent = 'Venue required'; valid = false;
            } else { document.getElementById('tVenueError').textContent = ''; }
            if (!document.getElementById('tDate').value) {
                document.getElementById('tDateError').textContent = 'Date required'; valid = false;
            } else { document.getElementById('tDateError').textContent = ''; }
            if (!valid) return;
            try {
                const res = await fetch('/api/tournaments', {
                    method: 'POST', headers: authHeaders(),
                    body: JSON.stringify({
                        name: document.getElementById('tName').value,
                        venue: document.getElementById('tVenue').value,
                        date: document.getElementById('tDate').value
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Tournament created');
                    loadTournaments();
                    document.getElementById('tournamentForm').classList.add('hidden');
                } else showToast(data.message, 'error');
            } catch { showToast('Network error', 'error'); }
        }

        // Load everything
        function setDropdownEmptyState(sel, message) {
            sel.innerHTML = `<option value="">${message}</option>`;
            sel.disabled = true;
        }
        // Example usage for empty dropdowns:
        // In loadSeasonsForAdminMatch, after fetching:
        // if (!seasons.length) setDropdownEmptyState(document.getElementById('adminMSeason'), 'No seasons available');
        // if (!tournaments.length) setDropdownEmptyState(document.getElementById('adminMTournament'), 'No tournaments available');
        document.addEventListener('DOMContentLoaded', () => {
            loadPending();
            loadUsers();
            loadSeasons();
            loadTournaments();
            loadAdminMatches();
        });

        // ‚îÄ‚îÄ‚îÄ Match Management (Admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let adminMatches = [];
        function showMatchForm(editId = null) {
            document.getElementById('adminMatchModalTitle').textContent = editId ? 'Edit Match' : 'Add Match';
            document.getElementById('adminMatchId').value = editId || '';
            if (editId) {
                const m = adminMatches.find(x => x.id === editId);
                document.getElementById('adminMDate').value = m.date;
                document.getElementById('adminMOpponent').value = m.opponent;
                document.getElementById('adminMVenue').value = m.venue;
                document.getElementById('adminMLink').value = m.match_link || '';
                document.getElementById('adminMResult').value = m.result || '';
                document.getElementById('adminMScore').value = m.score || '';
            } else {
                document.getElementById('adminMatchId').value = '';
                document.getElementById('adminMDate').value = '';
                document.getElementById('adminMOpponent').value = '';
                document.getElementById('adminMVenue').value = '';
                document.getElementById('adminMLink').value = '';
                document.getElementById('adminMResult').value = '';
                document.getElementById('adminMScore').value = '';
            }
            // Populate seasons and tournaments dropdowns
            loadSeasonsForAdminMatch();
            document.getElementById('adminMatchModal').classList.add('active');
        }

        async function loadAdminMatches() {
            try {
                const res = await fetch('/api/matches');
                adminMatches = await res.json();
                renderAdminMatches(adminMatches);
            } catch { }
        }

        function renderAdminMatches(list) {
            const body = document.getElementById('adminMatchesBody');
            const noMsg = document.getElementById('noAdminMatches');
            if (!list.length) { body.innerHTML = ''; noMsg.classList.remove('hidden'); return; }
            noMsg.classList.add('hidden');
            body.innerHTML = list.map(m => `
                <tr>
                    <td>${m.date}</td>
                    <td><strong>${esc(m.opponent)}</strong></td>
                    <td>${esc(m.venue)}</td>
                    <td>${m.season_id}</td>
                    <td>${m.tournament_id || '‚Äî'}</td>
                    <td>${m.result ? `<span class="badge badge-${m.result}">${m.result.toUpperCase()}</span>` : '<span class="text-muted">‚Äî</span>'}</td>
                    <td>${m.score || '‚Äî'}</td>
                    <td>${m.match_link ? `<a href="${esc(m.match_link)}" target="_blank">üîó</a>` : '‚Äî'}</td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="showMatchForm(${m.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAdminMatch(${m.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function submitAdminMatch(e) {
            e.preventDefault();
            let valid = true;
            if (!document.getElementById('adminMOpponent').value) {
                document.getElementById('adminMOpponentError').textContent = 'Opponent required'; valid = false;
            } else { document.getElementById('adminMOpponentError').textContent = ''; }
            if (!document.getElementById('adminMVenue').value) {
                document.getElementById('adminMVenueError').textContent = 'Venue required'; valid = false;
            } else { document.getElementById('adminMVenueError').textContent = ''; }
            if (!document.getElementById('adminMSeason').value) {
                document.getElementById('adminMDateError').textContent = 'Season required'; valid = false;
            } else { document.getElementById('adminMDateError').textContent = ''; }
            if (!valid) return;
            const id = document.getElementById('adminMatchId').value;
            const payload = {
                date: document.getElementById('adminMDate').value,
                opponent: document.getElementById('adminMOpponent').value,
                venue: document.getElementById('adminMVenue').value,
                season_id: parseInt(document.getElementById('adminMSeason').value),
                tournament_id: document.getElementById('adminMTournament').value ? parseInt(document.getElementById('adminMTournament').value) : null,
                match_link: document.getElementById('adminMLink').value || null,
                result: document.getElementById('adminMResult').value || null,
                score: document.getElementById('adminMScore').value || null
            };
            try {
                let res, data;
                if (id) {
                    res = await fetch('/api/matches/update', {
                        method: 'POST', headers: authHeaders(),
                        body: JSON.stringify({ id: parseInt(id), ...payload })
                    });
                    data = await res.json();
                    if (data.success) showToast('Match updated');
                    else showToast(data.message, 'error');
                } else {
                    res = await fetch('/api/matches', {
                        method: 'POST', headers: authHeaders(),
                        body: JSON.stringify(payload)
                    });
                    data = await res.json();
                    if (data.success) showToast('Match created');
                    else showToast(data.message, 'error');
                }
                closeModal('adminMatchModal');
                loadAdminMatches();
            } catch { showToast('Network error', 'error'); }
        }


        async function deleteAdminMatch(id) {
            if (!confirm('‚ö†Ô∏è This action cannot be undone. Delete this match?')) return;
            try {
                const res = await fetch(`/api/matches/${id}`, {
                    method: 'DELETE', headers: authHeaders()
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Match deleted');
                    loadAdminMatches();
                } else {
                    showToast(data.message, 'error');
                }
            } catch { showToast('Network error', 'error'); }
        }

        async function loadSeasonsForAdminMatch() {
            try {
                const [sRes, tRes] = await Promise.all([fetch('/api/seasons'), fetch('/api/tournaments')]);
                const seasons = await sRes.json();
                const tournaments = await tRes.json();
                document.getElementById('adminMSeason').innerHTML = seasons.map(s => `<option value="${s.id}">${esc(s.name)}</option>`).join('') || '<option value="">No seasons</option>';
                document.getElementById('adminMTournament').innerHTML = '<option value="">None</option>' + tournaments.map(t => `<option value="${t.id}">${esc(t.name)}</option>`).join('');
            } catch { }
        }
    </script>
</body>

</html>